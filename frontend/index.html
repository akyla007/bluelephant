<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>BlueElephant • Chat</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        body {
            background: radial-gradient(1000px circle at 10% 20%, #0d6efd22 0%, transparent 40%),
                radial-gradient(900px circle at 90% 10%, #6f42c122 0%, transparent 35%),
                #f8f9fa;
        }

        .chat-card {
            backdrop-filter: blur(8px);
            background: rgba(255, 255, 255, 0.85);
            border: 1px solid rgba(13, 110, 253, 0.1);
        }

        #messages {
            max-height: 360px;
            overflow-y: auto;
        }

        #messages li {
            background: #f1f5ff;
            border: 1px solid #e6ecff;
        }
    </style>
</head>

<body>
    <main class="container py-5">
        <div class="row g-4 justify-content-center">
            <div class="col-12 col-lg-8">
                <div class="d-flex align-items-center justify-content-between mb-4">
                    <div>
                        <h1 class="h3 mb-1 fw-semibold">BlueElephant Chat</h1>
                        <p class="text-muted mb-0">Converse em tempo real via WebSocket</p>
                    </div>
                    <span class="badge text-bg-primary">
                        Online: <span id="onlineCount">0</span>
                    </span>
                </div>

                <div class="card shadow-sm chat-card">
                    <div class="card-body">
                        <ul id="messages" class="list-unstyled d-grid gap-2 mb-3"></ul>

                        <div class="input-group">
                            <input id="messageInput" type="text" class="form-control" placeholder="Digite sua mensagem"
                                autocomplete="off" />
                            <button class="btn btn-primary" type="button" onclick="sendMessage()">Enviar</button>
                        </div>
                        <div class="d-flex align-items-center gap-2 mt-2">
                            <input id="imageInput" class="form-control" type="file" accept="image/*" />
                            <button class="btn btn-outline-primary" type="button" onclick="sendImage()">Enviar imagem</button>
                        </div>
                        <small class="text-muted d-block mt-2">Pressione Enter para enviar.</small>
                    </div>
                </div>
            </div>

            <div class="col-12 col-lg-4">
                <div class="card shadow-sm chat-card">
                    <div class="card-body">
                        <h2 class="h6 text-uppercase text-muted mb-3">Usuários online</h2>
                        <ul id="usersList" class="list-unstyled d-grid gap-2 mb-0"></ul>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        let displayName = "";

        while (!displayName) {
            displayName = (prompt("Digite seu nome para entrar no chat:") || "").trim();
        }

        const socket = new WebSocket(
            `ws://localhost:8000/ws?name=${encodeURIComponent(displayName)}`
        );

        const messages = document.getElementById("messages");
        const input = document.getElementById("messageInput");
        const usersList = document.getElementById("usersList");
        const onlineCount = document.getElementById("onlineCount");
        const imageInput = document.getElementById("imageInput");

        socket.onmessage = function (event) {
            const data = event.data;

            if (data.startsWith("{")) {
                try {
                    const payload = JSON.parse(data);
                    if (payload.type === "users" && Array.isArray(payload.items)) {
                        renderUsers(payload.items);
                        return;
                    }

                    if (payload.type === "message") {
                        renderMessage(payload);
                        return;
                    }
                } catch {
                    // fallback para mensagem comum
                }
            }

            renderMessage({
                message_type: "text",
                from: null,
                content: data,
            });
        };

        function sendMessage() {
            const value = input.value.trim();
            if (!value) return;
            socket.send(
                JSON.stringify({
                    type: "message",
                    message_type: "text",
                    content: value,
                })
            );
            input.value = "";
            input.focus();
        }

        input.addEventListener("keydown", (event) => {
            if (event.key === "Enter") {
                sendMessage();
            }
        });

        function sendImage() {
            const file = imageInput.files[0];
            if (!file) return;

            if (file.size > 1_500_000) {
                alert("A imagem é muito grande. Tente uma menor (até 1.5MB).");
                return;
            }

            const reader = new FileReader();
            reader.onload = () => {
                const dataUrl = reader.result;
                socket.send(
                    JSON.stringify({
                        type: "message",
                        message_type: "image",
                        content: dataUrl,
                    })
                );
                imageInput.value = "";
            };
            reader.readAsDataURL(file);
        }

        function renderMessage(payload) {
            const li = document.createElement("li");
            li.className = "px-3 py-2 rounded-3";

            if (payload.message_type === "system") {
                li.classList.add("text-muted", "fst-italic");
                li.textContent = payload.content;
            } else if (payload.message_type === "image") {
                const header = document.createElement("div");
                header.className = "small text-muted mb-2";
                header.textContent = payload.from ? `${payload.from}:` : "imagem";

                const image = document.createElement("img");
                image.src = payload.content;
                image.alt = "Imagem enviada";
                image.className = "img-fluid rounded border";

                li.appendChild(header);
                li.appendChild(image);
            } else {
                li.textContent = payload.from ? `${payload.from}: ${payload.content}` : payload.content;
            }

            messages.appendChild(li);
            messages.scrollTop = messages.scrollHeight;
        }

        function renderUsers(users) {
            const normalized = users
                .map((user) => ({
                    name: user.name,
                    online: Boolean(user.is_online),
                }))
                .sort((a, b) => Number(b.online) - Number(a.online) || a.name.localeCompare(b.name));

            usersList.innerHTML = "";
            onlineCount.textContent = normalized.filter((user) => user.online).length.toString();

            normalized.forEach((user) => {
                const li = document.createElement("li");
                li.className = "px-3 py-2 rounded-3 bg-light border d-flex align-items-center justify-content-between";
                li.innerHTML = `
                    <span>${user.name}</span>
                    <span class="badge ${user.online ? "text-bg-success" : "text-bg-secondary"}">
                        ${user.online ? "online" : "offline"}
                    </span>
                `;
                usersList.appendChild(li);
            });
        }
    </script>
</body>

</html>